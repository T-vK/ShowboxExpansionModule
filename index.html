<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmware Releases</title>
    <script type="module" src="https://unpkg.com/esp-web-tools@10.0.1/dist/web/install-button.js"></script>
    <script>
        async function fetchReleases() {
            const user = window.location.hostname.split('.')[0];
            const path = window.location.pathname.replace(/^\/|\/$/g, '');
            const url = `https://api.github.com/repos/${user}/${path}/releases`;

            const response = await fetch(url);
            const releases = await response.json();
            const releaseSelect = document.getElementById('release-select');
            const installButtonContainer= document.getElementById('install-button-container');

            releases.forEach(release => {
                const option = document.createElement('option');
                option.value = release.name;
                option.textContent = release.name;
                
                const manifest = release.assets.find(asset => asset.name === 'firmware-manifest.json');
                const manifestUrl = manifest ? manifest.browser_download_url : null;

                option.addEventListener('click', () => {
                    const installButton = document.createElement('esp-web-install-button');
                    installButton.setAttribute('manifest', manifestUrl);
                    installButtonContainer.appendChild(installButton);
                });

                releaseSelect.appendChild(option);
            });
            releaseSelect.children[0].click();
        }

        document.addEventListener('DOMContentLoaded', fetchReleases);
    </script>
</head>
<body>
    <h1>Firmware Releases</h1>
    <select id="release-select"></select>
    <div id="install-button-container"></div>
</body>
</html>
